<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Managed Services Woes, RabbitMQ Edition | Tales Of Details</title>
<meta name="keywords" content="">
<meta name="description" content="I love managed services. You need a message broker, I&rsquo;ll have one ready for you in 15&rsquo;.
We trade some money for ease of use and focus on the core deliverable, great.
But then we need a simple change. Make the message queue&rsquo;s endpoint public.
If you&rsquo;re using AWS MQ RabbitMQ and had created a private instance, then tried to flick a switch to make it public&hellip;
Let&rsquo;s start a support group, I&rsquo;ll bring the cookies and frustration :-P">
<meta name="author" content="
stelis">
<link rel="canonical" href="https://details.systematize.it/details/2024-09-28-managed-services-woes-rabbitmq/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.da3211e5ef867bf2b75fd5a6515cfed7195c011e8ab735694e203810a827097b.css" integrity="sha256-2jIR5e&#43;Ge/K3X9WmUVz&#43;1xlcAR6KtzVpTiA4EKgnCXs=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://details.systematize.it/assets/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://details.systematize.it/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://details.systematize.it/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://details.systematize.it/apple-touch-icon.png">
<link rel="mask-icon" href="https://details.systematize.it/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://details.systematize.it/details/2024-09-28-managed-services-woes-rabbitmq/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="https://details.systematize.it/details/2024-09-28-managed-services-woes-rabbitmq/">
  <meta property="og:site_name" content="Tales Of Details">
  <meta property="og:title" content="Managed Services Woes, RabbitMQ Edition">
  <meta property="og:description" content="I love managed services. You need a message broker, I’ll have one ready for you in 15’.
We trade some money for ease of use and focus on the core deliverable, great.
But then we need a simple change. Make the message queue’s endpoint public.
If you’re using AWS MQ RabbitMQ and had created a private instance, then tried to flick a switch to make it public…
Let’s start a support group, I’ll bring the cookies and frustration :-P">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="details">
    <meta property="article:published_time" content="2024-09-28T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-09-28T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Managed Services Woes, RabbitMQ Edition">
<meta name="twitter:description" content="I love managed services. You need a message broker, I&rsquo;ll have one ready for you in 15&rsquo;.
We trade some money for ease of use and focus on the core deliverable, great.
But then we need a simple change. Make the message queue&rsquo;s endpoint public.
If you&rsquo;re using AWS MQ RabbitMQ and had created a private instance, then tried to flick a switch to make it public&hellip;
Let&rsquo;s start a support group, I&rsquo;ll bring the cookies and frustration :-P">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Details",
      "item": "https://details.systematize.it/details/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Managed Services Woes, RabbitMQ Edition",
      "item": "https://details.systematize.it/details/2024-09-28-managed-services-woes-rabbitmq/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Managed Services Woes, RabbitMQ Edition",
  "name": "Managed Services Woes, RabbitMQ Edition",
  "description": "I love managed services. You need a message broker, I\u0026rsquo;ll have one ready for you in 15\u0026rsquo;.\nWe trade some money for ease of use and focus on the core deliverable, great.\nBut then we need a simple change. Make the message queue\u0026rsquo;s endpoint public.\nIf you\u0026rsquo;re using AWS MQ RabbitMQ and had created a private instance, then tried to flick a switch to make it public\u0026hellip;\nLet\u0026rsquo;s start a support group, I\u0026rsquo;ll bring the cookies and frustration :-P\n",
  "keywords": [
    
  ],
  "articleBody": "I love managed services. You need a message broker, I’ll have one ready for you in 15’.\nWe trade some money for ease of use and focus on the core deliverable, great.\nBut then we need a simple change. Make the message queue’s endpoint public.\nIf you’re using AWS MQ RabbitMQ and had created a private instance, then tried to flick a switch to make it public…\nLet’s start a support group, I’ll bring the cookies and frustration :-P\nPrivate or Public is a decision you need to make on creation and be happy with it forever on.\nSo what do we do if we now need it to be public and would really really prefer not to destroy and re-create?\nAfter all, this thing has data in it and it’s not trivial, if at all possible, to backup and restore existing messages, see here.\nWell, this is an option. Create a network load balancer exposing the RabbitMQ endpoints.\nAdded benefits: You get to NOT expose the management interface and on the service endpoint you can do IP Filtering.\nBut this is ClickOps, how do I turn it IaC? Here you go!\nCaveat: when creating the data.aws_network_interface.rabbit-enis resource and using it in the dependent resource to create the target group attachements, terraform complains that it cannot know in advance what this will look like after querying AWS for its content. So this needs to be applied first with the attachements commented out. Then you can create its dependent resources and you’re golden. Not sure if this is a limitation of terraform, the older terraform version I was using or of me. I was going to get the task finished and then look into this. but… you know, other things happened…\nresource \"aws_mq_broker\" \"mq\" { broker_name = \"my-mq-cluster\" publicly_accessible = \"false\" engine_type = \"RabbitMQ\" engine_version = \"3.X.Y\" auto_minor_version_upgrade = \"true\" host_instance_type = \"mq.m5.large\" storage_type = \"ebs\" deployment_mode = \"CLUSTER_MULTI_AZ\" apply_immediately = \"false\" subnet_ids = [aws_subnet.private-subnet-1.id, aws_subnet.private-subnet-2.id, aws_subnet.private-subnet-3.id] security_groups = [aws_security_group.rabbitmq.id] #allows access from VPC to ports 443 and 5671 of broker authentication_strategy = \"simple\" user { username = var.mq_user password = var.mq_password } encryption_options { use_aws_owned_key = \"true\" # not recommended, preferable to use CMK. Checkov will complain } logs { general = true } maintenance_window_start_time { day_of_week = \"SUNDAY\" time_of_day = \"06:00\" time_zone = \"UTC\" } } output \"mq_endpoints\" { value = aws_mq_broker.mq.instances.0.endpoints.0 } output \"mq_console_url\" { value = aws_mq_broker.mq.instances.0.console_url } resource \"aws_lb_target_group\" \"mq-tg\" { name = \"mq-tg\" port = 5671 protocol = \"TLS\" target_type = \"ip\" ip_address_type = \"ipv4\" vpc_id = aws_vpc.vpc.id health_check { enabled = true protocol = \"HTTPS\" port = \"443\" healthy_threshold = 5 unhealthy_threshold = 2 } } data \"aws_vpc_endpoint\" \"rabbitmq\" { vpc_id = aws_vpc.vpc.id filter { name = \"tag-value\" values = [aws_mq_broker.mq.id] } } data \"aws_network_interface\" \"rabbit-enis\" { for_each = data.aws_vpc_endpoint.rabbitmq.network_interface_ids id = each.key } resource \"aws_lb_target_group_attachment\" \"mq-ip-targets\" { for_each = data.aws_vpc_endpoint.rabbitmq.network_interface_ids target_group_arn = aws_lb_target_group.mq-tg.arn target_id = data.aws_network_interface.rabbit-enis[each.key].private_ip port = 5671 availability_zone = data.aws_network_interface.rabbit-enis[each.key].availability_zone } resource \"aws_lb\" \"mq-nlb\" { name = \"mq-nlb\" internal = false load_balancer_type = \"network\" subnets = [aws_subnet.public-subnet-1.id, aws_subnet.public-subnet-2.id, aws_subnet.public-subnet-3.id] enable_deletion_protection = false } resource \"aws_lb_listener\" \"mq-listener\" { load_balancer_arn = aws_lb.mq-nlb.arn port = \"5671\" protocol = \"TLS\" certificate_arn = aws_acm_certificate.my-domain-tld-cert.arn default_action { type = \"forward\" target_group_arn = aws_lb_target_group.mq-tg.arn } } resource \"aws_route53_record\" \"mq-record\" { zone_id = aws_route53_zone.my-domain-zone.zone_id name = \"mq.domain.tld\" type = \"A\" alias { name = aws_lb.mq-nlb.dns_name zone_id = aws_lb.mq-nlb.zone_id evaluate_target_health = true } } ",
  "wordCount" : "564",
  "inLanguage": "en",
  "datePublished": "2024-09-28T00:00:00Z",
  "dateModified": "2024-09-28T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": {"email":"stelis@systematize.it","name":"stelis"}
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://details.systematize.it/details/2024-09-28-managed-services-woes-rabbitmq/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Tales Of Details",
    "logo": {
      "@type": "ImageObject",
      "url": "https://details.systematize.it/assets/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://details.systematize.it/" accesskey="h" title="Tales Of Details (Alt + H)">Tales Of Details</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://details.systematize.it/">Home</a>&nbsp;»&nbsp;<a href="https://details.systematize.it/details/">Details</a></div>
    <h1 class="post-title entry-hint-parent">
      Managed Services Woes, RabbitMQ Edition
    </h1>
    <div class="post-meta"><span title='2024-09-28 00:00:00 +0000 UTC'>September 28, 2024</span>&nbsp;·&nbsp;<span>
<a href="mailto:stelis@systematize.it">stelis</a></span>

</div>
  </header> 
  <div class="post-content"><p>I love managed services. You need a message broker, I&rsquo;ll have one ready for you in 15&rsquo;.<br>
We trade some money for ease of use and focus on the core deliverable, great.</p>
<p>But then we need a simple change. Make the message queue&rsquo;s endpoint public.<br>
If you&rsquo;re using AWS MQ RabbitMQ and had created a private instance, then tried to flick a switch to make it public&hellip;<br>
Let&rsquo;s start a support group, I&rsquo;ll bring the cookies and frustration :-P</p>
<p><code>Private</code> or <code>Public</code> is a decision you need to make on creation and be happy with it forever on.<br>
So what do we do if we now need it to be public and would really really prefer not to destroy and re-create?<br>
After all, this thing has data in it and it&rsquo;s not trivial, if at all possible, to backup and restore existing messages, see <a href="https://www.rabbitmq.com/docs/backup">here</a>.</p>
<p>Well, <a href="https://aws.amazon.com/blogs/compute/creating-static-custom-domain-endpoints-with-amazon-mq-for-rabbitmq/">this</a> is an option. Create a network load balancer exposing the RabbitMQ endpoints.<br>
Added benefits: You get to NOT expose the management interface and on the service endpoint you can do IP Filtering.<br>
But this is ClickOps, how do I turn it IaC? Here you go!</p>
<blockquote>
<p><strong>Caveat</strong>: when creating the <code>data.aws_network_interface.rabbit-enis</code> resource and using it in the dependent resource to create the target group attachements, terraform complains that it cannot know in advance what this will look like after querying AWS for its content. So this needs to be applied first with the attachements commented out. Then you can create its dependent resources and you&rsquo;re golden. Not sure if this is a limitation of terraform, the older terraform version I was using or of me. I was going to get the task finished and then look into this. but&hellip; you know, other things happened&hellip;</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>resource <span style="color:#e6db74">&#34;aws_mq_broker&#34;</span> <span style="color:#e6db74">&#34;mq&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  broker_name                <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;my-mq-cluster&#34;</span>
</span></span><span style="display:flex;"><span>  publicly_accessible        <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>  engine_type                <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;RabbitMQ&#34;</span>
</span></span><span style="display:flex;"><span>  engine_version             <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;3.X.Y&#34;</span>
</span></span><span style="display:flex;"><span>  auto_minor_version_upgrade <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>  host_instance_type         <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mq.m5.large&#34;</span>
</span></span><span style="display:flex;"><span>  storage_type               <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ebs&#34;</span>
</span></span><span style="display:flex;"><span>  deployment_mode            <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CLUSTER_MULTI_AZ&#34;</span>
</span></span><span style="display:flex;"><span>  apply_immediately          <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>  subnet_ids                 <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>aws_subnet.private-subnet-1.id, aws_subnet.private-subnet-2.id, aws_subnet.private-subnet-3.id<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  security_groups            <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>aws_security_group.rabbitmq.id<span style="color:#f92672">]</span> <span style="color:#75715e">#allows access from VPC to ports 443 and 5671 of broker</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  authentication_strategy <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;simple&#34;</span>
</span></span><span style="display:flex;"><span>  user <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    username <span style="color:#f92672">=</span> var.mq_user
</span></span><span style="display:flex;"><span>    password <span style="color:#f92672">=</span> var.mq_password
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  encryption_options <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    use_aws_owned_key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;true&#34;</span> <span style="color:#75715e"># not recommended, preferable to use CMK. Checkov will complain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  logs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    general <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  maintenance_window_start_time <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    day_of_week <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SUNDAY&#34;</span>
</span></span><span style="display:flex;"><span>    time_of_day <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;06:00&#34;</span>
</span></span><span style="display:flex;"><span>    time_zone   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UTC&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#e6db74">&#34;mq_endpoints&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  value <span style="color:#f92672">=</span> aws_mq_broker.mq.instances.0.endpoints.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#e6db74">&#34;mq_console_url&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  value <span style="color:#f92672">=</span> aws_mq_broker.mq.instances.0.console_url
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resource <span style="color:#e6db74">&#34;aws_lb_target_group&#34;</span> <span style="color:#e6db74">&#34;mq-tg&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  name            <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mq-tg&#34;</span>
</span></span><span style="display:flex;"><span>  port            <span style="color:#f92672">=</span> <span style="color:#ae81ff">5671</span>
</span></span><span style="display:flex;"><span>  protocol        <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;TLS&#34;</span>
</span></span><span style="display:flex;"><span>  target_type     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ip&#34;</span>
</span></span><span style="display:flex;"><span>  ip_address_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ipv4&#34;</span>
</span></span><span style="display:flex;"><span>  vpc_id          <span style="color:#f92672">=</span> aws_vpc.vpc.id
</span></span><span style="display:flex;"><span>  health_check <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    enabled             <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span>    protocol            <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;HTTPS&#34;</span>
</span></span><span style="display:flex;"><span>    port                <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;443&#34;</span>
</span></span><span style="display:flex;"><span>    healthy_threshold   <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    unhealthy_threshold <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#e6db74">&#34;aws_vpc_endpoint&#34;</span> <span style="color:#e6db74">&#34;rabbitmq&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  vpc_id <span style="color:#f92672">=</span> aws_vpc.vpc.id
</span></span><span style="display:flex;"><span>  filter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    name   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;tag-value&#34;</span>
</span></span><span style="display:flex;"><span>    values <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>aws_mq_broker.mq.id<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#e6db74">&#34;aws_network_interface&#34;</span> <span style="color:#e6db74">&#34;rabbit-enis&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  for_each <span style="color:#f92672">=</span> data.aws_vpc_endpoint.rabbitmq.network_interface_ids
</span></span><span style="display:flex;"><span>  id       <span style="color:#f92672">=</span> each.key
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resource <span style="color:#e6db74">&#34;aws_lb_target_group_attachment&#34;</span> <span style="color:#e6db74">&#34;mq-ip-targets&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  for_each          <span style="color:#f92672">=</span> data.aws_vpc_endpoint.rabbitmq.network_interface_ids
</span></span><span style="display:flex;"><span>  target_group_arn  <span style="color:#f92672">=</span> aws_lb_target_group.mq-tg.arn
</span></span><span style="display:flex;"><span>  target_id         <span style="color:#f92672">=</span> data.aws_network_interface.rabbit-enis<span style="color:#f92672">[</span>each.key<span style="color:#f92672">]</span>.private_ip
</span></span><span style="display:flex;"><span>  port              <span style="color:#f92672">=</span> <span style="color:#ae81ff">5671</span>
</span></span><span style="display:flex;"><span>  availability_zone <span style="color:#f92672">=</span> data.aws_network_interface.rabbit-enis<span style="color:#f92672">[</span>each.key<span style="color:#f92672">]</span>.availability_zone
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resource <span style="color:#e6db74">&#34;aws_lb&#34;</span> <span style="color:#e6db74">&#34;mq-nlb&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  name               <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mq-nlb&#34;</span>
</span></span><span style="display:flex;"><span>  internal           <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>  load_balancer_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;network&#34;</span>
</span></span><span style="display:flex;"><span>  subnets            <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>aws_subnet.public-subnet-1.id, aws_subnet.public-subnet-2.id, aws_subnet.public-subnet-3.id<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  enable_deletion_protection <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resource <span style="color:#e6db74">&#34;aws_lb_listener&#34;</span> <span style="color:#e6db74">&#34;mq-listener&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  load_balancer_arn <span style="color:#f92672">=</span> aws_lb.mq-nlb.arn
</span></span><span style="display:flex;"><span>  port              <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;5671&#34;</span>
</span></span><span style="display:flex;"><span>  protocol          <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;TLS&#34;</span>
</span></span><span style="display:flex;"><span>  certificate_arn   <span style="color:#f92672">=</span> aws_acm_certificate.my-domain-tld-cert.arn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  default_action <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    type             <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;forward&#34;</span>
</span></span><span style="display:flex;"><span>    target_group_arn <span style="color:#f92672">=</span> aws_lb_target_group.mq-tg.arn
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resource <span style="color:#e6db74">&#34;aws_route53_record&#34;</span> <span style="color:#e6db74">&#34;mq-record&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  zone_id <span style="color:#f92672">=</span> aws_route53_zone.my-domain-zone.zone_id
</span></span><span style="display:flex;"><span>  name    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mq.domain.tld&#34;</span>
</span></span><span style="display:flex;"><span>  type    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  alias <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    name                   <span style="color:#f92672">=</span> aws_lb.mq-nlb.dns_name
</span></span><span style="display:flex;"><span>    zone_id                <span style="color:#f92672">=</span> aws_lb.mq-nlb.zone_id
</span></span><span style="display:flex;"><span>    evaluate_target_health <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://details.systematize.it/details/2024-10-04-was-this-piece-of-code-successful/">
    <span class="title">« Prev</span>
    <br>
    <span>Was this piece of code successful?</span>
  </a>
  <a class="next" href="https://details.systematize.it/details/2024-09-21-macos-setup-as-code/">
    <span class="title">Next »</span>
    <br>
    <span>macos setup as code</span>
  </a>
</nav>

  </footer><script src="https://utteranc.es/client.js"
        repo="stelispanagiotakis/details"
        issue-term="pathname"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="https://details.systematize.it/">Tales Of Details</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
